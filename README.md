<p align="center">
  <h1 align="center">
    Exthouse
  </h1>
</p>

<p align="center">
  Analyze impact of browser extension on web performance.
</p>

<p align="center">
  <img src="https://user-images.githubusercontent.com/158189/59514028-5904e680-8ebc-11e9-9e3f-bb6c9f8b464e.png" width="602" alt="Screenshot of Grammarly extension performance report generated by Exthouse">
</p>

Exthouse - tool, powered by [Lighthouse](https://github.com/GoogleChrome/lighthouse), provides with report (Lighthouse style ðŸ˜Ž) about impact on user performance by calculating all additional work extension added to the browser.

## Table of Contents

1.  [Motivation](#motivation)
1.  [Goals](#goals)
1.  [Install](#install)
1.  [Methodology](#methodology)
    1.  [Environment conditions](#environment-conditions)
    1.  [Measured metrics](#measured-metrics)
1.  [Usage](#usage)
1.  [Evaluate any extension](#evaluate-any-extension)
1.  [Future Work](#future-work)
1.  [Credits](#credits)

## Motivation

Often, measuring real user performance engineers take to the account factors, like device and network conditions.
But there is one more factor, that is not in direct control - web extensions. They add additional scripts, DOM manipulations, and impacts user exeperience.

Exthouse is a tool powered by [Lighthouse](https://github.com/GoogleChrome/lighthouse), that provides a report about web expetension impact on user performance.
It measures extension performance score, that helps developers to improve perforamnce of their extensions and web in general.

Inspired by https://twitter.com/denar90_/status/1065712688037277696

## Goals

1. Highlight one more performance factor affecting web performance.
2. Identify web extensions that have negative impact on web performance.
3. Provide developers with tool to measure extension performance score, hence helps them to improve perforamnce of their extensions and web in general.
4. Show that not only mobile users struggling with issue regrading performance, but also users on a desktop but by other factors - web extensions.

## Install

Install CLI using `npm`:

```bash
$ npm install --global exthouse
```

## Methodology

To do analysis Exthouse evaluate several main steps:

1. Unzip provided `EXTENSION_NAME.crx` file.

2. Launches browser 2 times.

  During first lunch:
   - URL is opened and performance results gathered.
   - Lighthouse performance results are stored in `./exthouse/result-default-1.json`.
  
  During second run:
   - Extension installed using Puppeteer.
   - URL is opened and performance results gathered.
   - Lighthouse performance results are stored in `./exthouse/EXTENSION_NAME-1.json`.

3. Extends Lighthouse performance categories with additional:

  - `exthouse-new-long-tasks` - The value represents a sum of Long Tasks. [Long Tasks](https://developer.mozilla.org/en-US/docs/Web/API/Long_Tasks_API) (weight: 1).
  - `exthouse-max-potential-fid-change` - The change for the longest task duration highlights the impact on potential First Input Delay (weight: 1).
  - `exthouse-extension-files` - Extension files add extra CPU consumption for every URL visit. Bundle resources into one and leverage hot chaching. [Learn more](https://v8.dev/blog/code-caching-for-devs) (weight: 1).
  - `exthouse-default-metrics` - All metrics collected from the default run (without extension) (weight: 0).

  Note: Scoring algorithm is based on [Lighthouse scoring algorithm](https://github.com/GoogleChrome/lighthouse/blob/master/docs/scoring.md#how-are-the-scores-weighted).

4. Generates Lightouse style report.

### Environment conditions

 - Browser: `Chromium`
 - Emulated form factor: `desktop`
 - CPU slowdown multiplier: `2`

More settings in [Lighthouse config](/src/utils/measure-chromium.js#L7).

### Measured metrics

- Time to interactive (TTI) - Time to interactive is the amount of time it takes for the page to become fully interactive. [Learn more](https://developers.google.com/web/tools/lighthouse/audits/time-to-interactive).
- First input delay (FID) - The change for the longest task duration highlights the impact on potential First Input Delay. [Learn more](https://developers.google.com/web/updates/2018/05/first-input-delay).

## Usage

```bash
exthouse [path/to/extension.crx] [options]

# Example
exthouse Grammarly-for-Chrome.crx --runs=3
```

**`$ exthouse --help`**

```
Options:
  --runs <number>    amount of runs to evaluate median performance value (default: "1")
  --url <url>        url to evaluate extension performance (default: "https://example.com/")
  --format <format>  output format options: [json,html] (default: "html")
  --disableGather    disable gathering and use /exthouse to produce results
  -V, --version      output the version number
  -h, --help         output usage information
```

## Evaluate any extension

1. Download extension using https://chrome-extension-downloader.com/
2. Copy path to the `MY_EXTENTION.crx` and pass to cli `exthouse MY_EXTENTION.crx --runs=3`
3. The process takes a few minutes and result are stored in the [Lighthouse](https://github.com/GoogleChrome/lighthouse) report.
4. All debug data is stored in `exthouse` folder.

## Future Work

- [ ] add support for login script to test extensions required authentication ([#22](https://github.com/treosh/exthouse/issues/22))
- [ ] experiment with cache (try: warm, hot) to see how scripts are effected by v8 caching. [More about cache](https://v8.dev/blog/code-caching-for-devs).
- [ ] experiment with results, running in Chrome and Edge. Add flag `browserBinaryPath`
- [ ] expose node.js API ([#24](https://github.com/treosh/exthouse/issues/24))
- [ ] experiment with Firefox add-ons (all related work is in the branch [firefox-experimental](https://github.com/treosh/exthouse/tree/firefox-experimental)).
- [ ] make repo smaller, try [bfg-repo-cleaner](https://github.com/rtyley/bfg-repo-cleaner).

## Credits

Sponsored by [Treo.sh - Page speed monitoring made easy](https://treo.sh).

[![](https://travis-ci.org/treosh/exthouse.png)](https://travis-ci.org/treosh/exthouse)
[![](https://img.shields.io/npm/v/exthouse.svg)](https://npmjs.org/package/exthouse)
[![](https://img.shields.io/badge/license-MIT-blue.svg)](./LICENSE)
